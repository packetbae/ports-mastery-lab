<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Scenario Mode — Ports Mastery</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{--bg:#f0f0f2;--fg:#0f1115;--muted:#6b6f76;--card:#ffffff;--accent:#0a84ff;--radius:18px;--shadow:0 10px 28px rgba(0,0,0,.08);--border:1px solid rgba(0,0,0,.06);--ok:#1d9f49;--bad:#ff3b30}
  @media (prefers-color-scheme: dark){:root{--bg:#121416;--fg:#f4f5f7;--muted:#9aa0a6;--card:#1a1c1f;--accent:#3b9cff;--border:1px solid rgba(255,255,255,.08)}}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  header{position:sticky;top:0;z-index:20;background:var(--bg);border-bottom:var(--border)}
  .nav{max-width:1120px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:10px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px rgba(10,132,255,.18)}
  .spacer{flex:1}
  .btn,.chip,select{background:transparent;border:var(--border);border-radius:999px;padding:8px 14px;color:inherit;text-decoration:none;font-weight:600;cursor:pointer}

  .toolbar{position:sticky; top:56px; z-index:15; background:var(--bg); border-bottom:var(--border)}
  .toolbar .wrap{max-width:1120px;margin:0 auto;padding:10px 20px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar select,.toolbar button{border-radius:12px}
  #countLabel{color:var(--muted);font-size:.9rem}

  main{max-width:1120px;margin:0 auto;padding:22px 20px 80px}
  h1{font-size:32px;margin:6px 0 10px}
  .lead{margin:0 0 14px;color:var(--muted)}
  .panel{border:var(--border);background:var(--card);border-radius:20px;padding:18px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:12px;margin-top:12px}
  .box{background:var(--card);border:var(--border);border-radius:12px;padding:12px}
  .box label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  input[type="number"], select{width:100%;padding:10px;border:var(--border);border-radius:10px;background:var(--card);color:inherit}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .chip input{accent-color:var(--accent)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .result{font-weight:800;margin-top:6px}
  .ok{color:var(--ok)} .no{color:var(--bad)}
  .good input,.good select{border-color:var(--ok);box-shadow:inset 0 0 0 9999px rgba(29,159,73,.08)}
  .bad  input,.bad  select{border-color:var(--bad);box-shadow:inset 0 0 0 9999px rgba(255,59,48,.08)}
  mark.hl-ok{background:rgba(255,235,59,.4);border-radius:2px;padding:0 2px;color:inherit}
  .explain{color:var(--muted);white-space:pre-line;margin-top:8px}
  .kgrid{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:8px;margin-top:8px}
  .k{background:var(--card);border:var(--border);border-radius:10px;padding:10px}
  .k b{display:block;margin-bottom:4px}

  .extras{margin-top:10px;display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:8px}
  .extra{border:var(--border);background:var(--card);border-radius:10px;padding:10px}
  .extra b{display:block;margin-bottom:4px}

  footer{max-width:1120px;margin:40px auto 60px;padding:0 20px;color:var(--muted);font-size:13px}
  @media(max-width:960px){
    .grid{grid-template-columns:1fr}
    h1{font-size:28px}
    .kgrid,.extras{grid-template-columns:1fr}
    .toolbar{top:54px}
  }
</style>
</head>
<body>
<header>
  <div class="nav">
    <a class="btn" href="../index.html" aria-label="Back">←</a>
    <div class="brand"><span class="dot" aria-hidden="true"></span><span>Scenario Mode</span></div>
    <span class="spacer"></span>
  </div>
</header>

<div class="toolbar" role="region" aria-label="Scenario controls">
  <div class="wrap">
    <select id="scenarioSel" title="Choose Scenario"></select>
    <span id="countLabel"></span>
    <button class="btn" id="prevBtn" aria-label="Previous">◀</button>
    <button class="btn" id="nextBtn" aria-label="Next">▶</button>
    <span style="flex:1"></span>
    <button class="btn" id="revealBtn">Reveal</button>
    <button class="btn" id="checkBtn">Check</button>
    <button class="btn" id="resetBtn">Reset</button>
    <button class="btn" id="shuffleBtn">Shuffle</button>
  </div>
</div>

<main>
  <h1>Scenario Mode</h1>
  <p class="lead">Read the scenario and select the correct <b>port</b>, <b>transport</b>, <b>security</b>, and <b>service</b>. Use <b>Check</b> to see feedback or <b>Reveal</b> to view the answer.</p>

  <section class="panel" id="pbq">
    <h2 id="title" style="margin:0 0 6px">Loading…</h2>
    <p id="desc" data-orig="" style="margin:0 0 12px"></p>

    <div class="grid">
      <div class="box" id="bPort">
        <label for="portInput">Port Number</label>
        <input id="portInput" type="number" min="1" max="65535" placeholder="e.g., 443"/>
      </div>

      <div class="box" id="bTransport">
        <label>Transport</label>
        <div class="row" role="radiogroup" aria-label="Transport">
          <label class="chip"><input type="radio" name="transport" value="TCP">TCP</label>
          <label class="chip"><input type="radio" name="transport" value="UDP">UDP</label>
          <label class="chip"><input type="radio" name="transport" value="Both">Both</label>
        </div>
      </div>

      <div class="box" id="bSecure">
        <label>Security</label>
        <div class="row" role="radiogroup" aria-label="Security">
          <label class="chip"><input type="radio" name="secure" value="Yes">Secure</label>
          <label class="chip"><input type="radio" name="secure" value="No">Not Secure</label>
        </div>
      </div>

      <div class="box" id="bService">
        <label for="serviceSel">Service Name</label>
        <select id="serviceSel">
          <option value="">Select service…</option>
          <option>HTTP</option><option>HTTPS</option><option>SSH</option><option>Telnet</option>
          <option>FTP</option><option>FTPS</option><option>SFTP</option>
          <option>SMTP</option><option>Submission (SMTP)</option><option>SMTPS</option>
          <option>POP3</option><option>POP3S</option><option>IMAP</option><option>IMAPS</option>
          <option>DNS</option><option>DHCP</option><option>TFTP</option>
          <option>SNMP</option><option>Syslog</option><option>NTP</option>
          <option>Kerberos</option><option>LDAP</option><option>LDAPS</option>
          <option>SMB</option><option>RDP</option>
          <option>SIP</option>
          <option>MySQL</option><option>MSSQL</option><option>PostgreSQL</option><option>Oracle DB</option>
          <option>RADIUS</option><option>TACACS+</option>
          <option>IKE/IPsec</option><option>L2TP</option><option>PPTP</option>
          <option>DoT (DNS over TLS)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="checkBtn2">Check</button>
      <button class="btn" id="revealBtn2">Reveal</button>
      <button class="btn" id="resetBtn2">Reset</button>
      <div id="score" class="result"></div>
    </div>

    <div id="explain" class="explain"></div>

    <div class="extras">
      <div class="extra" id="mnemo"><b>Mnemonic</b><div id="mnemoText" class="muted"></div></div>
      <div class="extra" id="story"><b>Sticky fact</b><div id="storyText" class="muted"></div></div>
    </div>

    <div id="kmeta" class="kgrid" aria-live="polite"></div>
  </section>
</main>

<footer>© <span id="year"></span> packetbae — All Rights Reserved</footer>

<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
function setPristine(p, text){ p.dataset.orig = text; p.innerHTML = text; }
function highlight(p, terms){
  let html = p.dataset.orig || p.innerHTML;
  (terms||[]).filter(Boolean).sort((a,b)=>b.length-a.length).forEach(t=>{
    const esc = t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    html = html.replace(new RegExp('(' + esc + ')','gi'),'<mark class="hl-ok">$1</mark>');
  });
  p.innerHTML = html;
}
function decorate(el, ok){ el.classList.remove('good','bad'); el.classList.add(ok?'good':'bad'); }
function getRadio(name){ const el = document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:""; }
function setRadio(name,val){ document.querySelectorAll('input[name="'+name+'"]').forEach(r=>r.checked=(r.value===val)); }
function clearRadios(name){ document.querySelectorAll('input[name="'+name+'"]').forEach(r=>r.checked=false); }

/* ===== Catalog ===== */
const CATALOG = [
  {svc:"HTTPS", port:"443", transport:"TCP", secure:"Yes", why:"TLS provides confidentiality and integrity for web traffic.", fn:"Encrypted web browsing.", keep:"Yes (edge)", when:"Public sites and APIs; force 80→443."},
  {svc:"HTTP", port:"80", transport:"TCP", secure:"No",  why:"Plain HTTP is cleartext.", fn:"Unencrypted web.", keep:"Maybe (edge — redirect)", when:"Redirect to HTTPS."},
  {svc:"SSH",  port:"22",  transport:"TCP", secure:"Yes", why:"Cryptographic remote shell.", fn:"Secure shell & tunneling.", keep:"Scoped only", when:"Admin access, SFTP/SCP."},
  {svc:"Telnet", port:"23", transport:"TCP", secure:"No", why:"Plaintext terminal.", fn:"Plain terminal.", keep:"Block", when:"Legacy only."},
  {svc:"TFTP", port:"69", transport:"UDP", secure:"No",  why:"No auth/encryption.", fn:"Trivial file transfer.", keep:"Internal only", when:"PXE boot, firmware."},
  {svc:"LDAP", port:"389", transport:"Both", secure:"No", why:"Clear until STARTTLS.", fn:"Directory lookups.", keep:"Internal", when:"Prefer STARTTLS."},
  {svc:"LDAPS", port:"636", transport:"TCP", secure:"Yes", why:"LDAP over TLS.", fn:"Encrypted directory.", keep:"Scoped", when:"Encrypted queries."},
  {svc:"DNS",  port:"53",  transport:"Both", secure:"No",  why:"UDP queries; TCP for AXFR/large.", fn:"Name resolution.", keep:"Edge yes (filtered)", when:"User queries, AXFR TCP."},
  {svc:"NTP",  port:"123", transport:"UDP", secure:"No",  why:"Lightweight time sync.", fn:"Clock sync.", keep:"Internal", when:"Domain time."},
  {svc:"Submission (SMTP)", port:"587", transport:"TCP", secure:"Yes", why:"Auth mail submission (STARTTLS).", fn:"Client submission.", keep:"Mail edge", when:"MUAs sending mail."},
  {svc:"SMTP", port:"25", transport:"TCP", secure:"No",  why:"Server relay, opportunistic TLS.", fn:"Server relay.", keep:"Mail edge", when:"MTA↔MTA."},
  {svc:"POP3S", port:"995", transport:"TCP", secure:"Yes", why:"POP over TLS.", fn:"Secure POP.", keep:"If used", when:"POP clients."},
  {svc:"IMAPS", port:"993", transport:"TCP", secure:"Yes", why:"IMAP over TLS.", fn:"Secure IMAP.", keep:"If used", when:"Mail sync."},
  {svc:"IMAP", port:"143", transport:"TCP", secure:"No",  why:"Clear unless STARTTLS.", fn:"Mailbox sync.", keep:"Prefer block", when:"Legacy scanners."},
  {svc:"SFTP", port:"22", transport:"TCP", secure:"Yes",  why:"File transfer over SSH.", fn:"Secure file transfer.", keep:"Scoped", when:"Automations."},
  {svc:"FTPS", port:"990", transport:"TCP", secure:"Yes", why:"FTP with TLS.", fn:"FTP+TLS.", keep:"Partner edge", when:"B2B transfers."},
  {svc:"RDP",  port:"3389", transport:"TCP", secure:"Yes", why:"TLS + NLA.", fn:"Remote desktop.", keep:"Internal", when:"Admin jump hosts."},
  {svc:"SMB",  port:"445", transport:"TCP", secure:"No",  why:"Windows file/printer.", fn:"File sharing.", keep:"Block edge", when:"Internal shares."},
  {svc:"SNMP", port:"161", transport:"UDP", secure:"No",  why:"Mgmt polling; use v3.", fn:"Device monitoring.", keep:"Internal", when:"NMS polling."},
  {svc:"Syslog", port:"514", transport:"Both", secure:"No", why:"UDP default; TCP exists.", fn:"Event logging.", keep:"Internal", when:"Log forwarding."},
  {svc:"Kerberos", port:"88", transport:"Both", secure:"Yes", why:"Ticket-based auth.", fn:"Authentication.", keep:"Internal", when:"Domain auth."},
  {svc:"IKE/IPsec", port:"500", transport:"UDP", secure:"Yes", why:"Negotiates IPsec SAs.", fn:"IPsec negotiation.", keep:"VPN edge", when:"Site-to-site/remote."},
  {svc:"SIP", port:"5060", transport:"Both", secure:"No",  why:"VoIP signaling (no TLS).", fn:"VoIP signaling.", keep:"Scoped", when:"PBX/phones."},
  {svc:"MySQL", port:"3306", transport:"TCP", secure:"No",  why:"DB listener; use TLS.", fn:"RDBMS connections.", keep:"Internal", when:"App↔DB."},
  {svc:"MSSQL", port:"1433", transport:"TCP", secure:"No",  why:"SQL Server default.", fn:"RDBMS connections.", keep:"Internal", when:"App↔DB."},
  {svc:"PostgreSQL", port:"5432", transport:"TCP", secure:"No", why:"Postgres default.", fn:"RDBMS connections.", keep:"Internal", when:"App↔DB."},
  {svc:"Oracle DB", port:"1521", transport:"TCP", secure:"No", why:"Oracle listener.", fn:"RDBMS connections.", keep:"Internal", when:"App↔DB."},
  {svc:"RADIUS", port:"1812", transport:"UDP", secure:"Yes", why:"AAA for network access.", fn:"Auth/author.", keep:"Internal", when:"802.1X/VPN."},
  {svc:"TACACS+", port:"49", transport:"TCP", secure:"Yes",  why:"Device admin AAA.", fn:"Admin AAA.", keep:"Internal", when:"Device logins."},
  {svc:"L2TP", port:"1701", transport:"UDP", secure:"No",  why:"No native crypto.", fn:"L2 tunneling.", keep:"With IPsec", when:"L2TP/IPsec."},
  {svc:"PPTP", port:"1723", transport:"TCP", secure:"No",  why:"Deprecated/weak.", fn:"Legacy VPN.", keep:"Block", when:"Migrate off."},
  {svc:"SMTPS", port:"465", transport:"TCP", secure:"Yes", why:"Implicit TLS SMTP.", fn:"Secure SMTP.", keep:"Mail edge", when:"Secure submission."},
  {svc:"DoT (DNS over TLS)", port:"853", transport:"TCP", secure:"Yes", why:"Encrypted DNS.", fn:"Encrypted DNS.", keep:"Edge/internal", when:"Resolver privacy."}
];

const MNEMONICS = {"HTTPS":"4-4-3 = three locks.","HTTP":"The open ‘80s web.","SSH":"Two keys → 22.","Telnet":"23 is “too free”.","TFTP":"Simple 69.","LDAP":"389 STARTTLS.","LDAPS":"636 = TLS.","DNS":"5 + 3 = DNS.","NTP":"1-2-3 time.","Submission (SMTP)":"587 = submit.","SMTP":"25 relay.","POP3S":"995 TLS.","IMAPS":"993 TLS.","IMAP":"143 clear.","SFTP":"22 via SSH.","FTPS":"990 TLS.","RDP":"3389 screen.","SMB":"445 shares.","SNMP":"161/162.","Syslog":"514 UDP.","Kerberos":"Tickets need time.","IKE/IPsec":"500 starts tunnel.","SIP":"5060 signal.","MySQL":"3306 DB.","MSSQL":"1433 DB.","PostgreSQL":"5432 DB.","Oracle DB":"1521 listener.","RADIUS":"1812 auth.","TACACS+":"49 admin.","L2TP":"1701 no crypto.","PPTP":"1723 legacy.","SMTPS":"465 TLS.","DoT (DNS over TLS)":"853 TLS DNS."};
const FACTS = {"HTTPS":"Redirect 80→443.","HTTP":"Use only for redirects.","SSH":"Use keys; limit exposure.","Telnet":"Replace with SSH.","TFTP":"Provisioning VLAN only.","LDAP":"Prefer STARTTLS/LDAPS.","LDAPS":"Validate cert chain.","DNS":"Restrict AXFR.","NTP":"Auth your time.","Submission (SMTP)":"Clients use 587.","SMTP":"Avoid open relay.","POP3S":"TLS from start.","IMAPS":"TLS from start.","IMAP":"Upgrade or block.","SFTP":"Chroot/key limits.","FTPS":"Doc passive ranges.","RDP":"MFA/VPN recommended.","SMB":"Disable v1; segment.","SNMP":"Prefer v3.","Syslog":"TCP/TLS for reliability.","Kerberos":"NTP is critical.","IKE/IPsec":"Harden gateways.","SIP":"Watch toll fraud.","MySQL":"Bind internal.","MSSQL":"Internal only.","PostgreSQL":"Limit exposure.","Oracle DB":"Protect listener.","RADIUS":"802.1X depends on it.","TACACS+":"Central admin audit.","L2TP":"Pair with IPsec.","PPTP":"Migrate away.","SMTPS":"Alt secure submit.","DoT (DNS over TLS)":"Encrypt resolver→upstream."};

/* ===== Scenario builders (neutral titles, ≥50 words) ===== */
const THEMES = ['payment','health','finance','education','retail','media','manufacturing','government','startup','research','logistics','travel','gaming','iot','energy','banking','insurance','legal','telecom','hospitality'];
const VERBS = ['must','needs to','is required to','has to','should','will','plans to','is expected to','is configured to','intends to'];
const CONTROLS = ['MFA enforced','scoped ACLs','TLS certificates pinned','SIEM logging','least privilege','change control','DR tested','backups validated','NTP synchronized','secrets rotated'];
const TITLE_FORMS = [
  'User Access Gateway for {adjective} {noun} over a {channel} path',
  'Internal Platform Providing {adjective} {noun} Across Zones',
  'Partner Integration Handling {adjective} {noun} Under Policy',
  'Operations Service Delivering {adjective} {noun} During Peak',
  'Edge Component Offering {adjective} {noun} With Guardrails',
  'Backend Service Exposing {adjective} {noun} to Clients',
  'Remote Capability Supporting {adjective} {noun} at Scale',
  'Service Backbone Enabling {adjective} {noun} Across Sites',
  'Client Workflow Depending on {adjective} {noun} Safely',
  'Modernization Track Mandating {adjective} {noun} in Prod',
  'Branch Connectivity Facilitating {adjective} {noun}',
  'On-Prem Connector Supplying {adjective} {noun}',
  'Multi-tenant Fabric Orchestrating {adjective} {noun}',
  'Public Edge Proxy Fronting {adjective} {noun}',
  'Private Core Hub Routing {adjective} {noun}',
  'Resilient Node Preserving {adjective} {noun}',
  'Access Tier Controlling {adjective} {noun}',
  'Compliance Plane Auditing {adjective} {noun}',
  'Customer Portal Handling {adjective} {noun}',
  'Automation Bus Transporting {adjective} {noun}'
];
const ADJ = { Yes:['encrypted','confidential','protected','TLS-wrapped'], No:['clear','legacy','unauthenticated','plain'] };
const NOUNS = {
  web:['content delivery','API sessions','portal traffic','browser flows'],
  shell:['admin sessions','command channels','maintenance access','secure console'],
  dir:['directory lookups','identity queries','account attributes','group searches'],
  dns:['name resolution','resolver queries','zone transfers','record updates'],
  mail:['message submission','mail relay','mailbox sync','notification flow'],
  time:['time sync','clock discipline','time beacons','fleet time'],
  file:['file transfers','artifact exchange','binary drops','package pulls'],
  db:['database connections','query traffic','replication lanes','metadata lookups'],
  auth:['login flows','ticket exchange','federation handoffs','session issuance'],
  log:['event forwarding','audit telemetry','syslog streams','alert delivery'],
  voip:['call signaling','endpoint registration','dial plan flows','presence updates'],
  vpn:['tunnel negotiation','secure site links','remote sessions','branch tunnels']
};
function nounGroup(fn){
  const f = fn.toLowerCase();
  if(/web|browser|api/.test(f)) return 'web';
  if(/shell|tunnel/.test(f)) return 'shell';
  if(/directory/.test(f)) return 'dir';
  if(/name|dns/.test(f)) return 'dns';
  if(/mail/.test(f)) return 'mail';
  if(/time|clock/.test(f)) return 'time';
  if(/file/.test(f)) return 'file';
  if(/db|rdbms|database/.test(f)) return 'db';
  if(/auth|ticket/.test(f)) return 'auth';
  if(/event|log/.test(f)) return 'log';
  if(/voip|phone|call/.test(f)) return 'voip';
  if(/ipsec|vpn/.test(f)) return 'vpn';
  return 'web';
}
function channelWord(t){ return t==='UDP'?'connectionless':'stateful'; }
function ensureMinWords(text, min){
  const filler = ' Apply least privilege, document change control, and restrict exposure to the smallest necessary scope to reduce risk while meeting operational requirements.';
  while(text.trim().split(/\s+/).length < min){ text += filler; }
  return text;
}
function neutralTitle(base, i){
  const ng = nounGroup(base.fn);
  const noun = (NOUNS[ng]||['service'])[i % (NOUNS[ng]||['service']).length];
  const form = TITLE_FORMS[i % TITLE_FORMS.length];
  const adjective = (ADJ[base.secure]||['relevant'])[i % (ADJ[base.secure]||['relevant']).length];
  const channel = channelWord(base.transport);
  return form.replace('{adjective}',adjective).replace('{noun}',noun).replace('{channel}',channel);
}
function neutralCues(base){
  const ng = nounGroup(base.fn);
  const pool = (NOUNS[ng]||[]).slice(0,2);
  return [
    base.secure==='Yes'?'encrypted':'clear',
    base.transport==='UDP'?'connectionless':'stateful',
    ...pool
  ];
}
function buildScenario(i){
  const base = CATALOG[i % CATALOG.length];
  const theme = THEMES[i % THEMES.length];
  const verb  = VERBS[(i*7) % VERBS.length];
  const control = CONTROLS[(i*5) % CONTROLS.length];

  const title = `${i+1}) ${neutralTitle(base, i)}`;
  let text = `A ${theme} system ${verb} provide ${base.secure==='Yes'?'encrypted':'clear'} ${base.fn.toLowerCase()} to end users and automated clients. The operations team prefers a ${base.transport==='UDP'?'connectionless exchange to minimize session overhead':'stateful stream to simplify reliability and control'}. Apply ${control}, consider firewall placement, and select the correct port, transport, security setting, and service to satisfy availability without unnecessary exposure or downgrade risks.`;
  text = ensureMinWords(text, 50);

  const cues = neutralCues(base);
  const ans  = { port: base.port, transport: base.transport, secure: base.secure, service: base.svc };
  const meta = { fn: base.fn, keep: base.keep, when: base.when, why: base.why };

  return { title, text, cues, ans, meta };
}
function generateScenarios(n){ const out=[]; for(let i=0;i<n;i++) out.push(buildScenario(i)); return out; }
const SCENARIOS = generateScenarios(20);

/* ===== DOM ===== */
const tTitle = $('title');
const tDesc  = $('desc');
const portInput = $('portInput');
const serviceSel = $('serviceSel');
const bPort = $('bPort');
const bTransport = $('bTransport');
const bSecure = $('bSecure');
const bService = $('bService');
const scoreEl = $('score');
const explainEl = $('explain');
const kmetaEl = $('kmeta');
const scenarioSel = $('scenarioSel');
const countLabel = $('countLabel');
const mnemoText = $('mnemoText');
const storyText = $('storyText');
let IDX = 0;
const titleFor = (i,t)=>`${i+1}) ${t.replace(/^\d+\)\s*/, '')}`;

function clearAll(){
  portInput.value=""; ["transport","secure"].forEach(clearRadios); serviceSel.value="";
  [bPort,bTransport,bSecure,bService].forEach(b=>b.classList.remove('good','bad'));
  scoreEl.textContent=""; scoreEl.className="result"; explainEl.textContent=""; kmetaEl.innerHTML="";
  mnemoText.textContent=""; storyText.textContent="";
  setPristine(tDesc, tDesc.dataset.orig || tDesc.innerHTML);
}
function loadScenario(i){
  IDX = Math.max(0, Math.min(SCENARIOS.length-1, i));
  const s = SCENARIOS[IDX];
  tTitle.textContent = titleFor(IDX, s.title);
  setPristine(tDesc, s.text);
  clearAll();
  scenarioSel.value = String(IDX);
}
function showMeta(s){
  kmetaEl.innerHTML = `
    <div class="k"><b>Function</b>${s.meta.fn}</div>
    <div class="k"><b>Keep Open?</b>${s.meta.keep}
      <div style="margin-top:6px"><b>Typical Use</b><br/>${s.meta.when}</div>
    </div>`;
}
function addMemoryAids(s){
  const key = s.ans.service;
  mnemoText.textContent = MNEMONICS[key] || '';
  storyText.textContent = FACTS[key] || '';
}
function longWhy(s, chosen, correct){
  const core = `${s.ans.service} operates over ${s.ans.transport} on port ${s.ans.port} and is ${s.ans.secure==='Yes'?'typically encrypted end-to-end':'commonly deployed in cleartext unless upgraded'}. In practice, teams use it for ${s.meta.fn.toLowerCase()} and scope exposure based on role and zone. ${s.meta.why} For production, ${s.meta.keep.toLowerCase()} and usage such as ${s.meta.when.toLowerCase()}.`;
  if (correct) return `Correct — ${core} The selection aligns with the scenario’s channel preference and security expectations while reducing attack surface and avoiding downgrade or misrouting across control points.`;
  const hints = [];
  if(String(chosen.port||'') !== s.ans.port) hints.push(`use port ${s.ans.port}`);
  if(chosen.transport !== s.ans.transport) hints.push(`select ${s.ans.transport}`);
  if(chosen.secure !== s.ans.secure) hints.push(`mark security as ${s.ans.secure}`);
  if(chosen.service !== s.ans.service) hints.push(`choose the ${s.ans.service} service`);
  return `Not quite — adjust to ${hints.join(', ')}. ${core} Selecting the canonical mapping meets availability, supports policy enforcement, and prevents avoidable troubleshooting pain later.`;
}
function check(){
  const s = SCENARIOS[IDX];
  const chosen = {
    port: String(portInput.value || ""),
    transport: getRadio("transport"),
    secure: getRadio("secure"),
    service: serviceSel.value
  };
  const ok1 = chosen.port === s.ans.port;
  const ok2 = chosen.transport === s.ans.transport;
  const ok3 = chosen.secure === s.ans.secure;
  const ok4 = chosen.service === s.ans.service;
  decorate(bPort, ok1); decorate(bTransport, ok2); decorate(bSecure, ok3); decorate(bService, ok4);
  const allOk = ok1 && ok2 && ok3 && ok4;
  scoreEl.textContent = allOk ? "Correct" : "Try again";
  scoreEl.className = "result " + (allOk ? "ok":"no");
  highlight(tDesc, s.cues);
  explainEl.textContent = longWhy(s, chosen, allOk);
  showMeta(s);
  addMemoryAids(s);
}
function reveal(){
  const s = SCENARIOS[IDX];
  portInput.value = s.ans.port; setRadio("transport", s.ans.transport); setRadio("secure", s.ans.secure); serviceSel.value = s.ans.service;
  [bPort,bTransport,bSecure,bService].forEach(b=>decorate(b,true));
  scoreEl.textContent = "Revealed"; scoreEl.className = "result ok";
  highlight(tDesc, s.cues);
  explainEl.textContent = longWhy(s, s.ans, true);
  showMeta(s);
  addMemoryAids(s);
}
function shuffle(){
  for(let i=SCENARIOS.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [SCENARIOS[i],SCENARIOS[j]]=[SCENARIOS[j],SCENARIOS[i]]; }
  scenarioSel.innerHTML = SCENARIOS.map((s,i)=>`<option value="${i}">${titleFor(i,s.title)}</option>`).join('');
  countLabel.textContent = `(${SCENARIOS.length} scenarios loaded)`;
  loadScenario(0);
}
function next(){ loadScenario(Math.min(IDX+1, SCENARIOS.length-1)); }
function prev(){ loadScenario(Math.max(IDX-1, 0)); }

/* ===== Init ===== */
function init(){
  scenarioSel.innerHTML = SCENARIOS.map((s,i)=>`<option value="${i}">${titleFor(i,s.title)}</option>`).join('');
  countLabel.textContent = `(${SCENARIOS.length} scenarios loaded)`;

  ['checkBtn','checkBtn2'].forEach(id=>$(id)?.addEventListener('click',check));
  ['revealBtn','revealBtn2'].forEach(id=>$(id)?.addEventListener('click',reveal));
  ['resetBtn','resetBtn2'].forEach(id=>$(id)?.addEventListener('click',()=>loadScenario(IDX)));
  $('shuffleBtn')?.addEventListener('click',shuffle);
  $('nextBtn')?.addEventListener('click',next);
  $('prevBtn')?.addEventListener('click',prev);
  scenarioSel.addEventListener('change',e=>loadScenario(Number(e.target.value)));

  loadScenario(0);
  $('year').textContent = new Date().getFullYear();
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
